CREATE TABLE DEPT (
    DEPTNO INT ,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50),
    PRIMARY KEY (DEPTNO)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT ,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL DECIMAL(10,2),
    DEPTNO INT,
    PRIMARY KEY (EMPNO),
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
    PNO INT ,
    PNAME VARCHAR(50),
    PLOC VARCHAR(50),
    PRIMARY KEY (PNO)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10,2),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);

INSERT INTO DEPT VALUES
(10, 'HR', 'Bengaluru'),
(20, 'Finance', 'Mysuru'),
(30, 'IT', 'Hyderabad'),
(40, 'Sales', 'Chennai'),
(50, 'R&D', 'Bengaluru');

SELECT*FROM DEPT;

INSERT INTO EMPLOYEE VALUES
(101, 'Asha', NULL, '2020-03-15', 55000, 10),
(102, 'Ravi', 101, '2019-07-20', 60000, 20),
(103, 'Priya', 101, '2021-01-10', 58000, 30),
(104, 'Kiran', 102, '2022-04-05', 50000, 40),
(105, 'Deepa', 103, '2023-05-12', 62000, 50),
(106, 'Manu', 102, '2024-01-01', 57000, 10);

SELECT*FROM EMPLOYEE;

INSERT INTO PROJECT VALUES
(201, 'Payroll System', 'Mysuru'),
(202, 'Inventory', 'Bengaluru'),
(203, 'Bank Portal', 'Hyderabad'),
(204, 'CRM', 'Chennai'),
(205, 'AI Research', 'Bengaluru');

SELECT*FROM PROJECT;

INSERT INTO ASSIGNED_TO VALUES
(101, 202, 'Manager'),
(102, 201, 'Analyst'),
(103, 203, 'Developer'),
(104, 204, 'Tester'),
(105, 205, 'Researcher'),
(106, 202, 'Assistant');

SELECT*FROM ASSIGNED_TO;

INSERT INTO INCENTIVES VALUES
(101, '2024-12-10', 2000),
(102, '2024-11-15', 3000),
(103, '2024-09-20', 2500),
(104, '2024-06-16', 3600),
(105, '2024-09-24', 4500);

SELECT*FROM INCENTIVES;

SELECT DISTINCT (A.EMPNO)
FROM ASSIGNED_TO A
JOIN PROJECT P ON A.PNO = P.PNO
WHERE P.PLOC IN ('Bengaluru', 'Hyderabad', 'Mysuru');

SELECT EMPNO 
FROM EMPLOYEE 
WHERE EMPNO NOT IN ( SELECT EMPNO FROM INCENTIVES);


SELECT E.ENAME, E.EMPNO, D.DNAME, A.JOB_ROLE, D.DLOC AS DEPT_LOCATION, P.PLOC AS PROJECT_LOCATION
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
JOIN PROJECT P ON A.PNO = P.PNO
WHERE D.DLOC = P.PLOC;

SELECT E.ENAME AS MANAGER_NAME
FROM EMPLOYEE E
JOIN (
    SELECT MGR_NO, COUNT(*) AS EMP_COUNT
    FROM EMPLOYEE
    WHERE MGR_NO IS NOT NULL
    GROUP BY MGR_NO
    HAVING COUNT(*) = (
        SELECT MAX(CNT)
        FROM (
            SELECT COUNT(*) AS CNT
            FROM EMPLOYEE
            WHERE MGR_NO IS NOT NULL
            GROUP BY MGR_NO
        ) AS TEMP
    )
) AS M ON E.EMPNO = M.MGR_NO;


 
SELECT ENAME
FROM EMPLOYEE M
WHERE SAL > (
    SELECT AVG(SAL)
    FROM EMPLOYEE
    WHERE MGR_NO = M.EMPNO
);

SELECT DISTINCT E.ENAME AS SECOND_TOP_MANAGER, D.DNAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE M.MGR_NO IS NULL; 

SELECT E.*
FROM EMPLOYEE E
JOIN INCENTIVES I ON E.EMPNO = I.EMPNO
WHERE I.INCENTIVE_DATE >= '2019-01-01'
  AND I.INCENTIVE_DATE < '2019-02-01'
  AND I.INCENTIVE_AMOUNT = (
      SELECT MAX(INCENTIVE_AMOUNT)
      FROM INCENTIVES
      WHERE INCENTIVE_DATE >= '2019-01-01'
        AND INCENTIVE_DATE < '2019-02-01'
        AND INCENTIVE_AMOUNT < (
            SELECT MAX(INCENTIVE_AMOUNT)
            FROM INCENTIVES
            WHERE INCENTIVE_DATE >= '2019-01-01'
              AND INCENTIVE_DATE < '2019-02-01'
        )
  );
  
SELECT E.EMPNO, E.ENAME, E.DEPTNO, D.DNAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.DEPTNO = M.DEPTNO;

